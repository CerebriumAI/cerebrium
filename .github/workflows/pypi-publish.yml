name: Publish to PyPI

on:
  release:
    types: [published]

permissions:
  id-token: write # Required for OIDC trusted publishing
  contents: read

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Update version in Python package
        run: |
          # Get version from tag (e.g., "v2.1.0" or "v2.1.0-beta.1")
          GITHUB_VERSION="${{ github.event.release.tag_name }}"
          GITHUB_VERSION="${GITHUB_VERSION#v}"  # Remove 'v' prefix

          # Update VERSION in cerebrium_cli.py (stores GitHub/semver format)
          sed -i "s/^VERSION = \".*\"/VERSION = \"$GITHUB_VERSION\"/" python-wrapper/cerebrium_cli.py

          echo "Updated VERSION in cerebrium_cli.py to: $GITHUB_VERSION"

          # Convert to PEP 440 format for pyproject.toml
          cd python-wrapper
          PYPI_VERSION=$(python -c "from cerebrium_cli import github_to_pypi_version; print(github_to_pypi_version('$GITHUB_VERSION'))")
          cd ..

          # Update version in pyproject.toml (stores PEP 440 format)
          sed -i "s/^version = \".*\"/version = \"$PYPI_VERSION\"/" python-wrapper/pyproject.toml

          echo "Updated version in pyproject.toml to: $PYPI_VERSION"

      - name: Build Python package
        working-directory: python-wrapper
        run: |
          python -m build
          ls -la dist/

      - name: Check package
        working-directory: python-wrapper
        run: |
          twine check dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: python-wrapper/dist/
          skip-existing: true

      - name: Test installation from PyPI
        run: |
          # Get the PEP 440 version for pip install
          cd python-wrapper
          PYPI_VERSION=$(python -c "from cerebrium_cli import __version__; print(__version__)")
          cd ..

          # Create a clean virtual environment
          python -m venv test_env
          source test_env/bin/activate

          # Retry installation with exponential backoff
          MAX_ATTEMPTS=5
          ATTEMPT=1
          DELAY=30

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            if pip install cerebrium==$PYPI_VERSION; then
              echo "Successfully installed cerebrium $PYPI_VERSION from PyPI"

              # Test that the wrapper runs (will download binary on first run)
              echo "Testing cerebrium command..."
              cerebrium version && echo "Binary download and execution successful!"
              exit 0
            else
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "Package not yet available on PyPI. Waiting ${DELAY}s before retry..."
                sleep $DELAY
                DELAY=$((DELAY * 2))  # Exponential backoff
              fi
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "ERROR: Failed to install cerebrium $PYPI_VERSION from PyPI after $MAX_ATTEMPTS attempts"
          exit 1
