name: Test Signing Secrets

on:
  workflow_dispatch:

jobs:
  test-secrets:
    name: Verify Signing Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check Required Secrets
        run: |
          echo "Checking if secrets are configured..."

          # Check each secret (will show "***" if set, empty if not)
          if [ -z "${{ secrets.MACOS_CERTIFICATE_P12 }}" ]; then
            echo "❌ MACOS_CERTIFICATE_P12 is NOT set"
            exit 1
          else
            echo "✅ MACOS_CERTIFICATE_P12 is set"
          fi

          if [ -z "${{ secrets.MACOS_CERTIFICATE_PASSWORD }}" ]; then
            echo "❌ MACOS_CERTIFICATE_PASSWORD is NOT set"
            exit 1
          else
            echo "✅ MACOS_CERTIFICATE_PASSWORD is set"
          fi

          if [ -z "${{ secrets.MACOS_NOTARIZATION_KEY }}" ]; then
            echo "❌ MACOS_NOTARIZATION_KEY is NOT set"
            exit 1
          else
            echo "✅ MACOS_NOTARIZATION_KEY is set"
          fi

          if [ -z "${{ secrets.MACOS_NOTARIZATION_KEY_ID }}" ]; then
            echo "❌ MACOS_NOTARIZATION_KEY_ID is NOT set"
            exit 1
          else
            echo "✅ MACOS_NOTARIZATION_KEY_ID is set"
          fi

          if [ -z "${{ secrets.MACOS_NOTARIZATION_ISSUER_ID }}" ]; then
            echo "❌ MACOS_NOTARIZATION_ISSUER_ID is NOT set"
            exit 1
          else
            echo "✅ MACOS_NOTARIZATION_ISSUER_ID is set"
          fi

          echo ""
          echo "All required secrets are configured! ✅"

      - name: Validate Certificate Format
        run: |
          # Try to decode the base64 certificate (won't show content)
          echo "${{ secrets.MACOS_CERTIFICATE_P12 }}" | base64 -d > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "✅ MACOS_CERTIFICATE_P12 is valid base64"
          else
            echo "❌ MACOS_CERTIFICATE_P12 is not valid base64"
            exit 1
          fi

          echo "${{ secrets.MACOS_NOTARIZATION_KEY }}" | base64 -d > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "✅ MACOS_NOTARIZATION_KEY is valid base64"
          else
            echo "❌ MACOS_NOTARIZATION_KEY is not valid base64"
            exit 1
          fi

          echo ""
          echo "All certificates are properly base64 encoded! ✅"
